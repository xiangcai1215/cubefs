# 文件系统类型相关

## 文件类型



Linux文件系统提供有7中类型，包括普通文件、块设备、字符设备、目录、硬链接、管道文件、套接字文件。

| 文件类型     | 类型标识符 | 描述                                      |
| :----------- | :--------- | :---------------------------------------- |
| 普通文件     | `-`        | 包含文本、二进制、脚本等各种类型的文件。  |
| 目录         | `d`        | 用于存储其他文件和目录的容器。            |
| 符号链接     | `l`        | 指向其他文件或目录的快捷方式。            |
| 块设备文件   | `b`        | 提供对块设备（如硬盘、CD-ROM 等）的访问。 |
| 字符设备文件 | `c`        | 提供对字符设备（如终端、键盘等）的访问。  |
| 套接字文件   | `s`        | 用于进程间通信。                          |
| 管道文件     | `p`        | 用于进程间通信。                          |

执行ls命令可以查看文件详细信息：

```
brw-rw---- 1 root disk 8, 3 May 31 16:50 /dev/sda3
```

具体解释如下：

- `b`：表示这是一个块设备文件，也就是一个可随机访问的设备文件。
- `rw-`：表示文件所有者（root）具有读写权限，文件所属组（disk）具有读写权限，其他用户没有任何权限。
- `1`：表示该文件有一个硬链接，即有一个文件名和它指向同一个文件。
- `root`：表示文件所有者是 root 用户。
- `disk`：表示文件所属组是 disk 组。
- `8, 3`：表示这个设备文件的主设备号和次设备号，用于标识设备类型和驱动程序。
- `May 31 16:50`：表示该文件的最后修改时间是在 2022 年 5 月 31 日 16:50。
- `/dev/sda3`：表示设备文件的路径和名称，即第三个 SCSI 硬盘分区。

## 创建不同类型文件命令

主要介绍Mknod命令

`mknod` 是一个 Linux 命令，用于创建特殊类型的文件，如字符设备文件、块设备文件等。它的语法如下：

```
mknod [OPTION]... NAME TYPE [MAJOR MINOR]
```

其中，`NAME` 表示要创建的文件名，`TYPE` 表示要创建的文件类型，`MAJOR` 和 `MINOR` 表示设备文件的主设备号和次设备号。下面是 `mknod` 命令常用的文件类型及其说明：

- 字符设备文件：使用 `c` 表示，用于提供对字符设备（如终端、打印机等）的访问。创建字符设备文件时，需要指定主设备号和次设备号。例如，创建名为 `ttyS0` 的串口设备文件的命令如下：

  ```
  sudo mknod /dev/ttyS0 c 4 64
  ```

- 块设备文件：使用 `b` 表示，用于提供对块设备（如硬盘、CD-ROM 等）的访问。创建块设备文件时，同样需要指定主设备号和次设备号。例如，创建名为 `sda` 的硬盘设备文件的命令如下：

  ```
  sudo mknod /dev/sda b 8 0
  ```

- 命名管道文件：使用 `p` 表示，用于进程间通信。创建命名管道文件时，只需要指定文件名即可。例如，创建名为 `mypipe` 的命名管道文件的命令如下：

  ```
  sudo mknod /tmp/mypipe p
  ```

## 文件的扩展属性

在 Linux 中，文件的扩展属性（Extended Attributes，简称 xattr）是一种用于存储与文件相关的额外信息的机制。扩展属性可以包含任何类型的数据，可以用于存储文件的元数据、访问控制信息、加密密钥等信息。以下是一些常见的文件扩展属性：

- `user` 属性：用于存储用户自定义的属性。可以使用 `setfattr` 命令设置 `user` 属性。例如，将名为 `file.txt` 的文件的 `user` 属性设置为 `myattr`，属性值为 `myvalue` 的命令如下：

  Copy

  ```
  setfattr -n user.myattr -v myvalue file.txt
  ```

- `security` 属性：用于存储文件安全上下文信息。例如，在 SELinux 中，可以使用 `security` 属性存储文件的安全上下文信息。可以使用 `setfattr` 命令设置 `security` 属性。

- `trusted` 属性：用于存储受信任的文件元数据信息。例如，可以使用 `trusted` 属性存储文件的加密密钥。可以使用 `setfattr` 命令设置 `trusted` 属性。

- `system` 属性：用于存储文件系统相关的信息。例如，在 Btrfs 文件系统中，可以使用 `system` 属性存储文件的压缩和校验信息。可以使用 `setfattr` 命令设置 `system` 属性。

需要注意的是，不是所有的文件系统都支持扩展属性。在使用扩展属性时，需要确保文件系统支持扩展属性，并且需要使用支持扩展属性的命令来进行操作，如 `setfattr`、`getfattr`、`chattr` 等。

# 文件IO

## 函数sync、fsync、fdatasync

Linux系统在内核中内核缓存或者页缓存，大多数磁盘的IO通过缓冲区进行，用户写数据会先复制到缓存区中，然后排入队列，然后再等级Io调度写入磁盘。这个部分称为延迟写入。当操作系统需要重用缓存区时候，就会把所有延迟写数据块写入磁盘。

- `sync` ：将所有修改过的块缓存区排入写队列，返回就返回，实际不会等待写磁盘操作。这里通常是由于pdflush的守护进程每隔30s做一次flush操作
- `fsync`：将某个文件的数据从缓存持久化到磁盘，这里函数只针对特定句柄fd起作用，并且等待写磁盘操作结束才返回，一般用于数据库这样程序
- `fdatasync`:指的是将某个文件的数据从缓存持久化到磁盘

## page cache和buffer cache

一种事务两种表现，page cache缓存文件缓存数据，buffer cache缓存是块设备的数据。flush操作的是page cache。page cache大小一般是4K,buffer cahce大小一般是512字节。

![img](https://s3.51cto.com/oss/202108/31/1e5686130ed2ffd482b472b070dfc871.png)

![(https://pic4.zhimg.com/80/v2-81564e470653c78d61b085ccaf266257_720w.webp)